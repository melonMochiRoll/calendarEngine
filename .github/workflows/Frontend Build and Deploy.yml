name: Frontend Build and Deploy
run-name: üöÄ Deploying

on:
  push:
    branches: [ "release" ]

permissions:
  contents: 'read'
  id-token: 'write'

jobs:
  build_and_deploy:
    name: Build And Deploy
    runs-on: ubuntu-latest
    environment: production
    env:
      REACT_APP_NODE_ENV: production

    strategy:
      matrix:
        node-version: [24.x]

    steps:
    - name: ‚úÖ Check out repository code
      uses: actions/checkout@v4
    
    - name: üßæ Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    # - name: ‚ú® Install dependencies
    #   run: npm ci
    
    # - name: üî® Build Project
    #   run: npm run build -- --mode production
    
    # - name: üíª Get Github Actions IP
    #   id: ip
    #   uses: haythem/public-ip@v1.2

    # - name: üîß Set Dist Filename
    #   id: dist
    #   run: |
    #     filename="calendar-engine-front-$(date +%Y%m%d)"
    #     echo "dist_filename=$filename" >> $GITHUB_OUTPUT

    # - name: üîß Configure AWS Credentials
    #   uses: aws-actions/configure-aws-credentials@v1
    #   with:
    #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
    #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    #     aws-region: ${{ vars.AWS_REGION }}

    # - name: üîë Add Github Actions IP to Security group
    #   run: |
    #     aws ec2 authorize-security-group-ingress --group-id ${{ secrets.AWS_SG_ID }} --protocol tcp --port ${{ secrets.EC2_SSH_PORT }} --cidr ${{ steps.ip.outputs.ipv4 }}/32

    - name: üîß Authenticate to Google Cloud
      uses: 'google-github-actions/auth@v3'
      with:
        create_credentials_file: true
        project_id: project-3739142a-3b07-4f1f-981
        workload_identity_provider: projects\524323867905\locations\global\workloadIdentityPools\github\providers\calendarengine

    - name: üîß Set up Cloud SDK
      uses: 'google-github-actions/setup-gcloud@v3'

    - name: Use gcloud CLI
      run: 'gcloud info'

    # - name: üì¶ Compress Build Files
    #   run: tar cvf ${{ steps.dist.outputs.dist_filename }}.tar -C ./dist .

    # - name: ‚¨ÜÔ∏è Upload to R2
    #   uses: ryand56/r2-upload-action@latest
    #   with:
    #     r2-account-id: ${{ secrets.R2_ACCOUNT_ID }}
    #     r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
    #     r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
    #     r2-bucket: ${{ secrets.R2_BUCKET }}
    #     source-dir: ./${{ steps.dist.outputs.dist_filename }}.tar
    #     destination-dir: artifacts   

    # - name: ‚¨áÔ∏è Download from S3
    #   uses: appleboy/ssh-action@master
    #   with:
    #     host: ${{ secrets.EC2_HOST }} # 
    #     username: ${{ secrets.EC2_USERNAME }}
    #     key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
    #     port: ${{ secrets.EC2_SSH_PORT }}
    #     script_stop: true
    #     script: |
    #       aws s3 cp --region ${{ vars.AWS_REGION }} s3://${{ secrets.S3_BUCKET_NAME }}/${{ steps.dist.outputs.dist_filename }}.tar /home/ec2-user/
    #       rm -rf client_dist/*
    #       tar xvf ${{ steps.dist.outputs.dist_filename }}.tar -C ./client_dist .
    #       rm -r ${{ steps.dist.outputs.dist_filename }}.tar
    #       sudo service nginx restart
        
    # - name: üîë Remove Github Actions IP From Security Group
    #   if: always()
    #   run: |
    #     aws ec2 revoke-security-group-ingress --group-id ${{ secrets.AWS_SG_ID }} --protocol tcp --port ${{ secrets.EC2_SSH_PORT }} --cidr ${{ steps.ip.outputs.ipv4 }}/32
