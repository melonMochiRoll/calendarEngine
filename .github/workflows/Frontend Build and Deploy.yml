name: Frontend Build and Deploy
run-name: ${{ github.actor }} is testing out GitHub Actions ğŸš€

# on:
#   push:
#     branches: [ "release" ]

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    env:
      REACT_APP_NODE_ENV: production

    strategy:
      matrix:
        node-version: [18.x]

    steps:
    - name: âœ… Check out repository code
      uses: actions/checkout@v4
    
    - name: ğŸ§¾ Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: âœ¨ Install dependencies
      run: npm ci
    
    - name: ğŸ”¨ Build Project
      run: npm run build -- --mode production

    - name: Debug
      run: |
        echo "Current Working Directory: $(pwd)"
        echo "--- Contents of current directory ---"
        ls -Fal
        echo "--- Contents of dist/ (if exists) ---"
        ls -Fal dist/ || echo "dist/ directory not found or empty." # distê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ê°€ ì•„ë‹Œ ë©”ì‹œì§€ ì¶œë ¥
        echo "--- Searching for 'dist' directory ---"
        find . -maxdepth 2 -name "dist" -type d # í˜„ì¬ ë° í•˜ìœ„ 1ë‹¨ê³„ê¹Œì§€ë§Œ ê²€ìƒ‰

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: build
    environment: production

    steps:
    - name: ğŸ’» Get Github Actions IP
      id: ip
      uses: haythem/public-ip@v1.2

    - name: ğŸ”‘ Add Github Actions IP to Security group
      run: |
        aws ec2 authorize-security-group-ingress --group-id ${{ secrets.AWS_SG_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32

    - name: ğŸ”§ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
        
    - name: ğŸ”§ Set SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/ec2_rsa
        chmod 600 ~/.ssh/ec2_rsa

    - name: ğŸš› Upload to S3
      run: aws s3 cp --region ${{ vars.AWS_REGION }} ./ì••ì¶•íŒŒì¼ì´ë¦„.zip s3://${{ secrets.S3_BUCKET_NAME }}/${{ env.S3_BUCKET_DIR_NAME }}/ì••ì¶•íŒŒì¼ì´ë¦„.zip

    - name: Download from S3
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.AWS_SSH_HOST }} # 
        username: ${{ secrets.AWS_SSH_USERNAME }}
        key: ${{ secrets.AWS_SSH_KEY }}
        port: ${{ secrets.AWS_SSH_PORT }}
        script_stop: true
        script: |
          aws s3 cp s3://${{ secrets.S3_BUCKET_NAME }}/${{ env.S3_BUCKET_DIR_NAME }}/ì••ì¶•íŒŒì¼ì´ë¦„.zip /home/ec2-user/client_dist
          sudo service nginx restart
          pm2 restart main

    # - name: ğŸš€ Deploy to EC2
    #   run: |
    #     SOURCE_DIR="${GITHUB_WORKSPACE}/dist/"
    #     TARGET_DIR="ec2-user@${{ secrets.EC2_HOST }}:/home/ec2-user/client_dist"
    #     rsync -avz --delete -e "ssh -i ~/.ssh/ec2_rsa -o StrictHostKeyChecking=no" ${SOURCE_DIR} ${TARGET_DIR}
        
    - name: ğŸ”‘ Remove Github Actions IP From Security Group
      run: |
        aws ec2 revoke-security-group-ingress --group-id ${{ secrets.AWS_SG_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32
